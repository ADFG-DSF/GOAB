################################################################################
# RFSummary.sas A summary of sport harvested rockfish
# bjf 10/10/14
# MDS 10/23/18 for project review
# 
# Translated by from SAS to R by CWM on 05/30/23
################################################################################

library(tidyverse)

get_data <- function(a) {

  print(a)
  
  files <- list.files(path=a,
                      pattern="*.csv", full.names=F, recursive=FALSE)
  
  
  for(i in seq(1, length(files))) {
    print(files[[i]])
    n <- gsub(".csv", "",files[[i]])
    assign(n, read.csv(paste0(a,files[[i]])), envir = .GlobalEnv)
    
  }
  
}

#Function call
get_data("O:/DSF/GOAB/R data/RF/")


#Combine data
library(plyr)
rock <- do.call(rbind.fill, list(rock9195, rock9600, rock2001, rock2002, rock2003, 
                                     rock2004, rock2005, rock2006, rock2007, rock2008, 
                                     rock2009, rock2010, rock2011, rock2012, rock2013, 
                                     rock2014, rock2015, rock2016, rock2017, rock2018, 
                                     rock2019, rock2020, rock2021, rock2022))
detach(package:plyr)

#
rock <- rock %>%
  filter(ASSEMB != '') %>%
  mutate(USER = if_else(USER == '', 'Unknown', USER)) %>%
  filter(STATAREA != '') %>%
  filter(STATAREA >= 100000) %>%
  mutate(MgmtArea = case_when(
    STATAREA < 490000 & STATAREA >= 440000 & !STATAREA %in% c(485832, 485902, 485933, 485934) ~ 'PWS',
    STATAREA %in% c(485832, 485902, 485933, 485934, 485935, 486002, 495831, 495901, 495902,
                    495931, 495932, 495933, 495934, 495935, 495936, 495937, 495938, 495939, 496001, 496002,
                    505831, 505901, 505902, 505903, 505904, 505905, 505906, 505907, 505908, 505909, 505931, 505932,
                    505933, 505934) ~ 'NG',
    STATAREA %in% c(495800, 495832, 505700, 505730, 505800, 505832, 515630, 515700, 515730,
                    515801, 515802, 515833, 525600, 525630, 525701, 525702, 525703, 525731, 525732, 525733,
                    525801, 525802, 525803, 525804, 525805, 525806, 525807, 525832, 525833, 525834, 535601,
                    535602, 535631, 535632, 535633, 535634, 535701, 535702, 535703, 535704, 535705, 535706,
                    535707, 535731, 535732, 535733, 535734, 535802, 535803, 535831, 545601, 545602, 545631,
                    545632, 545633, 545701, 545702, 545703, 545704, 545732, 545733, 545734, 545804, 555630,
                    555701, 555733) ~ 'Kod',
    STATAREA %in% c(555731, 555732, 545731, 545801, 545802, 545803, 535801, 535832) ~ 'AP',
    STATAREA %in% c(515831, 515832, 515901, 515902, 515903, 515904, 515905, 515906, 515907,
                    515908, 515931, 515932, 515933, 515934, 515935, 515936, 515937, 515938,
                    515939, 516001, 516002, 525831, 525835, 525836, 525837, 525901, 525902,
                    525931, 525932, 526002, 526003, 535833, 535834, 535901, 535902, 535903,
                    535904, 535905, 535906, 535931, 535932, 535933, 545900) ~ 'CI',
    TRUE ~ 'Err'
  )) %>%
  mutate(MgmtArea = if_else(MgmtArea == 'PWS' & STATAREA / 10000 < 47, 'EPWS', MgmtArea)) %>%
  mutate(MgmtArea = if_else(MgmtArea == 'PWS' & STATAREA / 10000 > 47, 'WPWS', MgmtArea))

rock <- rock %>%
  mutate(SFmgmtarea = if_else(
    STATAREA > 440000 & STATAREA < 480000 |
      STATAREA %in% c(485430, 485500, 485530, 485600, 485630, 485700, 485730, 485800, 485831,
                      485901, 485931, 485932, 485935, 486001, 486002, 486003, 486004, 486005,
                      486031, 486032, 486033, 486034, 486100),
    "PWS",
    if_else(
      STATAREA %in% c(485832, 485902, 485933, 485934, 485935, 486002, 495831, 495901, 495902,
                      495931, 495932, 495933, 495934, 495935, 495936, 495937, 495938, 495939,
                      496001, 496002, 505831, 505901, 505902, 505903, 505904, 505905, 505906,
                      505907, 505908, 505909, 505931, 505932, 505933, 505934),
      "NG",
      if_else(
        STATAREA %in% c(495800, 495832, 505700, 505730, 505800, 505832, 515630, 515700,
                        515730, 515801, 515802, 515833, 525600, 525630, 525701, 525702, 525703,
                        525731, 525732, 525733, 525801, 525802, 525803, 525804, 525805, 525806,
                        525807, 525832, 525833, 525834, 535601, 535602, 535631, 535632, 535633,
                        535634, 535701, 535702, 535703, 535704, 535705, 535706, 535707, 535731,
                        535732, 535733, 535734, 535802, 535803, 535831, 545601, 545602, 545631,
                        545632, 545633, 545701, 545702, 545703, 545704, 545732, 545733, 545734,
                        545804, 555630, 555701, 555733),
        "Kod",
        if_else(
          STATAREA %in% c(555731, 555732, 545731, 545801, 545802, 545803, 535801, 535832),
          "AKPen",
          if_else(
            STATAREA %in% c(515831,515832,515901,515902,515903,515904,515905,515906,515907,
                            515908,515931,515932,515933,515934,515935,515936,515937,515938,	515939,
                            516001,516002,525831,525835,525836,525837,525901,525902,525931,	525932,
                            526002,526003,535833,535834,535901,535902,535903,535904,535905,535906,
                            535931,	535932,535933,545900),
            "CI",
            if_else(
              is.na(STATAREA),
              case_when(
                PORT == "Homer" ~ "CI",
                PORT == "Kodiak" ~ "Kod",
                PORT == "Whittier" ~ "PWS",
                PORT == "Valdez" ~ "PWS"),
              "CI")))))))

# Sort the 'rock' dataset by mgmtarea, year, and species
rock <- rock %>% arrange(MgmtArea, YEAR, SPECIES)

# Perform frequency analysis
spcomp <- rock %>% 
  group_by(MgmtArea, YEAR, SPECIES) %>%
  summarise(count = n()) %>%
  mutate(percent = count / sum(count) * 100)

# Print the resulting dataset
spcomp                


# Export the filtered dataset to a CSV file
write_csv(spcomp, "O:/DSF/GOAB/Data_requests/Mike_Booz/AMR/spcomp9122LCI.csv")
